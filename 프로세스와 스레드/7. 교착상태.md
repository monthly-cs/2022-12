# **교착 상태**

이 문서는 2022년 12월 7일에 @kwanyung에 의해서 작성되었습니다.

```
1. 교착 상태의 개념
    1.1 교착 상태의 예시

2. 교착 상태의 발생 조건

3. 교착 상태의 해결 방법
    3.1 교착 상태 예방
        3.1.1 상호배제 조건 방지
        3.1.2 점유와 대기 조건 방지
        3.1.3 비선점 조건 방지
    3.2 교착 상태 회피
    3.3 교착 상태 회복


```

# **1. 교착 상태의 개념**

> 다중 프로그래밍 시스템에서 프로세스가 결코 일어나지 않을 사건을 기다리는 상태

- 한 개 이상의 프로세스가 교착 상태에 빠지면 작업이 정지되어 더는 명령을 진행할 수 없게 됨.
- 운영 체제가 교착 상태를 해결하지 못하면 시스템 운영자나 사용자는 작업을 교체하거나 종료하는 외부 간섭으로 해결해야함.

![교착상태](https://user-images.githubusercontent.com/71562311/207600594-3acdfce1-c99f-41da-b8c4-afda5e895250.jpeg)

_보기만 해도 답답해지는 그림.._

교차로에 있는 일부의 차가 후진하거나 차를 제거하는 등의 외부 간섭이 없으면 교통마비를 해결할 수 없음.

![교착상태2](https://user-images.githubusercontent.com/71562311/207600822-736eed5a-a360-406f-bdab-704de8fa0bad.jpeg)



- 프로세스 A는 프린터의 작업을 디스크를 이용해 해결하려 하고
- 프로세스 B는 디스크의 작업을 프린터를 이용해 해결하려 하고
- 디스크가 B를 놔줘야 프로세스 A는 자신의 일을 처리할 수 있음.
- 프린터가 A를 놔줘야 프로세스 B는 자신의 일을 처리할 수 있음.

## 교착 상태는 제항된 자원의 사용률을 높이고 시스템 효율성을 증가시키려고 사용하는 병행 처리 기술과 자원 공유에 따른 부작용!

---

프로세스는 다음의 순서로 자원을 사용함.

1. 자원 요청

- 프로세스가 필요한 자원을 요청한다. (해당 자원을 사용할 수 있으면 요청 수락! 사용 할 수 없다면 기다려야함..)

2. 자원 사용

- 프로세스가 요청한 자원을 획득하여 사용한다.

3. 자원 해제

- 프로세스가 자원 사용을 마친 후 해당 자원을 되돌려준다.

교착상태는 필요한 자원을 다른 작업이 점유하여 사용할 수 없을 때 발생하므로 교착 상태에서는 자원의 요청과 해제가 중요함!

---

# **2. 교착 상태의 발생 조건**

1. 상호배제

- 자원을 최소 하나 이상 비공유해야 함.
  - 한 번에 프로세스 하나만 해당 자원을 사용할 수 있어야 함.
  - 사용 중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제될 때 까지 기다려야 한다.

2. 점유와 대기

- 자원을 최소한 하나 정도는 보유하고, 다른 프로세스에 할당된 자원을 얻으려고 기다리는 프로세스가 있어야 한다.

3. 비선점

- 자원은 선점할 수 없음!
  - 자원은 강제로 빼앗을 수 없고, 자원을 점유하고 있는 프로세스가 끝나야 해제 됨.

4. 순환대기

   ![순환 대기](https://user-images.githubusercontent.com/71562311/207601146-d3520cad-bfce-45e0-88ed-31a47d210e7e.png)


- 위의 그림과 같이 서로 자원을 물고 물은 상태에서 다음 프로세스의 자원을 얻으려 기다리는 상태

+선점자원과 비선점 자원
-
  
- 선점 자원 : 부작용 없이 소유한 프로세스에서 빼앗아 선점할 수 있는 자원
- 비선점 자원: 하나의 프로세스에서 빼앗아 선점할 수 없고 부작용 없이 다른 프로세스에 할당할 수 없는 자원

![교착상태 강건너기](https://user-images.githubusercontent.com/71562311/207600902-6d936d4e-34c8-4940-9606-e2e5b043023b.jpeg)


---

# **3. 교착 상태의 해결 방법**

교착 상태를 해결하는 방법은 크게 다음 세가지로 나눌 수 있음.

1.  교착 상태가 발생하지 않도록 `예방하기`
2.  교착 상태의 방생 가능성을 배제하지 않고 `회피하기`
3.  교찯 상태를 허용하고 교착 상태를 탐지해 다시 `회복하기`

## **3.1 교착 상태의 예방**

> 예방 방법은 대체적으로 좋은 방법이 아님.

### 1. 자원의 상호배제 조건 방지

상호배제 조건은 자원의 비공유가 전제되어야 함.

- 공유 자원은 배타적인 접근이 필요 없으므로 교착상태가 발생하지 않음.
  - 읽기 전용 파일은 공유 자원의 좋은 예시
- 어떤 자원은 공유 자체가 불가능 할 수도 있음. - 하지만 파일 쓰기는 배타적인 접근만 허용해야 해 교착 상태가 발생할 수 있음.
  > 일반적으로 상호배제 조건을 만족하지 않으면 교착 상태를 예방할 수 없음.

### 2. 점유와 대기 조건 방지

점유와 대기 조건이 발생하지 않으려면, 프로세스가 작업을 수행하기 전에 필요한 자원을 모두 요청하고 획득해야 함.

- 프로세스가 실행에 필요한 자원을 한꺼번에 요구하고 허용할 때까지 작업을 보류하여 대기 조건이 성립하지 않도록 하는 것.

점유와 대기 조건 방지에는 두가지 단점이 있는데

- 자원의 효율성이 낮음.
  - 많은 자원이 사용되지 않으면서 오랫동안 할당되어 있기 때문.
- 기아 상태가 발생할 수 있음.
  - 자주 사용하는 자원이 다른 프로세스에 할당되어 있는 프로세스는 무한정 기다려야 하는 경우가 발생

### 3. 비선점 조건 방지

이미 할당된 자원에 선점권이 없어야 함.

- 어떤 자원을 가진 프로세스가 다른 자원을 요청할 때 요청한 자원을 할당받을 수 없어 기다려야 한다면 프로세스는 현재 가진 자원을 모두 해제해야 함.
- 프로세스에 a,b,c라는 자원이 필요한데 a,b라는 자원은 확보했지만 c 자원이 없으면 모아둔 a,b도 다시 버리는 것.

비선점 조건 방지에도 단점이 있음.

- 이미 실행한 작업의 상태를 잃을 수 있음.
- 다른 프로세스의 자원을 빼앗고 복구하는 과정은 간단하지 않음.

---

교착상태 예방은 교착 상태의 발생 조건 중 최소한 하나라도 성립하지 않도록 자원 요청을 제한하는 것.

=> 전체적으로 장치의 효율성과 시스템 처리량을 떨어뜨리는 결과를 초래..

## **3.2 교착 상태 회피**

교착 상태 회피는 교착 상태가 발생할 가능성을 인정하고(세 가지 필요조건 허용)교착 상태가 발생하려 하면 적절히 회피하는 것.

### 프로세스 시작 중단

- 프로세스의 요구가 교착 상태를 발생시킬 수 있다면 프로세스 시작을 중단.

### 자원 할당 거부

- 프로세스가 요청한 자원을 할당했을 때 교착 상태가 발생할 수 있다면 요청한 자원을 할당하지 않음.
- 대표적으로 은행가 알고리즘.

> 은행가 알고리즘

![스크린샷 2022-12-14 오후 9 28 35](https://user-images.githubusercontent.com/71562311/207601001-65df35fb-298c-4813-a453-94198c6dc57b.png)


- 은행 금고 : 컴퓨터 자원
- 사람 : 프로세스
- 돈 : 자원

위의 그림에서 각 고객들에게 돈을 빌려주고 은행에는 $20가 남았음.

이 $20을 이용해 두 번째 남자 고객에게 돈을 $10만 더 빌려주면 $40을 반환받아 은행 금고에는 $50가 남게됨.

- 프로세스의 자원 반환 단계를 기억하기!

이와 같은 상태를 안전상태라고 함.

![스크린샷 2022-12-14 오후 9 28 44](https://user-images.githubusercontent.com/71562311/207601051-3aeb1ebd-d69d-42c5-8f06-dd5f579e3f5b.png)



하지만 그림과 같이 배분을 하게되면 은행 금고에는 $5만 남아 더이상 아무에게도 돈을 빌려줄 수 없는 상태가 되어버림..

이와 같은 상태를 불안전 상태라 함.

- 불안전상태는 교착상태이기 위한 필요조건.

> 은행원 알고리즘은 최소한 고객 한명에게 대출해줄 금액은 항상 은행이 보유하고 있어야 한다는 개념에서 나옴.

시스템은 항상 안전상태로 유지할 수 있게 만드는 것이 은행가 알고리즘.

자원 요청을 승낙하는 것이 불안전 상태에서 시스템을 배치할 수 있다고 판단하면 요청을 연기하거나 거부하여 교착 상태를 예방.

[자세한 은행원 알고리즘 ](https://jhnyang.tistory.com/102)

---

## **3.3 교착 상태의 회복**

교착 상태가 발생하면 회복하는 방법.

두가지의 알고리즘이 필요한데

- 시스템 상태를 검사하는 교착 상태 탐지 알고리즘
- 교착 상태에서 회복시키는 알고리즘

교착상태 탐지 알고리즘을 너무 자주 실행하면 시스템의 성능은 떨어지지만 교착상태를 빠르게 파악해 자원 유휴 상태를 방지할 수 있음.

자주 실행하지 않으면 반대의 경우가 발생.

[교착상태 탐지 알고리즘](https://hoyeonkim795.github.io/posts/%ED%83%90%EC%A7%80%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/)
: 탐지 알고리즘은 교착상태 회복의 깊은 부분이라 링크!

---

## 이후 교착상태를 회복하는 방법

### 프로세스 중단

- 교착 상태에 빠져있는 프로세스에 할당되어 있는 모든 자원의 해제를 요청
  - 교착 상태 프로세스를 모두 중단
    - 교착 상태의 순환 대기를 확실히 해결하지만 자원 사용과 시간 면에서 비용이 많이 들음.
  - 한 프로세스씩 중단
    - 한 프로세스를 중단할 때마다 교착 상태 탐지 알고리즘을 호출해야해 부담이 상당히 큼.

프로세스 중단 자체가 어려울 수 있어 효율적인 방법이 아님.

### 자원 선점

프로세스의 자원을 선점해서 교착 상태를 해결할 때까지 선점한 자원을 다른 프로세스에 할당해야 함.

- 희생자를 정해서 한 프로세스를 죽이는 것.
- 희생당한 프로세스는 일반적으로 진행 상태 정보를 잃어 재시작하는 것이 좋음.
